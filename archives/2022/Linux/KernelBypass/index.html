
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../../Finance/Trading/">
      
      
        <link rel="next" href="../Linux/">
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.15">
    
    
      
        <title>Kernel Bypass - ThinkNotes</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.26e3688c.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.ecc896b0.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=IBM+Plex+Serif:300,300i,400,400i,700,700i%7CRoboto+Mono,+10:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"IBM Plex Serif";--md-code-font:"Roboto Mono, 10"}</style>
      
    
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="yellow">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#kernel-bypass" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="ThinkNotes" class="md-header__button md-logo" aria-label="ThinkNotes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ThinkNotes
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Kernel Bypass
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="ThinkNotes" class="md-nav__button md-logo" aria-label="ThinkNotes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    ThinkNotes
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        About ThinkNotes
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          2023
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          2023
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
      
      
      
        <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
          Linux
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          Linux
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../2023/Linux/endeavour/" class="md-nav__link">
        Endeavour OS
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          About
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          About
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../about/bio/" class="md-nav__link">
        Bio
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          Archives
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Archives
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_1" >
      
      
      
        <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
          2016
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_1">
          <span class="md-nav__icon md-icon"></span>
          2016
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2016/2016-04-02-lky-on-management/" class="md-nav__link">
        LKY on Management
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2016/2016-04-03-insprirational-quotes/" class="md-nav__link">
        Inspirational Quotes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2016/2016-04-07-getting-things-done/" class="md-nav__link">
        Getting Things Done
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2016/2016-05-01-sg-math-primary-five-ratio/" class="md-nav__link">
        Singapore Math Primary 5 Five Ratio Question
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2016/2016-05-02-sg-math-second_math_question/" class="md-nav__link">
        Singapore Math Primary 5 Second Math Question
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2016/2016-09-11-fifteen-years-on/" class="md-nav__link">
        Fifteen Years On
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2016/2016-09-18-get-through-hard/" class="md-nav__link">
        Get through hard
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2016/2016-10-08-the-management-masterclass/" class="md-nav__link">
        The Management Masterclass
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2016/2016-10-09-the-spirit-of-kaizen/" class="md-nav__link">
        The Spirit of Kaizen
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2016/2016-12-08-riskfree-profit-strategies/" class="md-nav__link">
        Risk-free Profit Strategies
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2016/2016-12-30-revisting-generic-collections/" class="md-nav__link">
        Revisiting Generic Collections
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
      
      
      
        <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
          2017
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_2">
          <span class="md-nav__icon md-icon"></span>
          2017
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2017/2017-03-21-timing_numpy/" class="md-nav__link">
        Timing NumPy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2017/2017-04-23-the-tao-of_charlie-munger/" class="md-nav__link">
        The Tao of Charlie Munger
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2017/2017-06-03-fooled-by-randomness/" class="md-nav__link">
        Fooled By Randomness
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2017/2017-06-08-python_import/" class="md-nav__link">
        Imports in Python
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2017/2017-06-11-basic-matplotlib/" class="md-nav__link">
        Basic Matplotlib Plot
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2017/2017-06-24-the-effective-engineer/" class="md-nav__link">
        The Effective Engineer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2017/2017-09-03-managing/" class="md-nav__link">
        Managing, by Harold Geneen
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" >
      
      
      
        <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
          2019
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_3">
          <span class="md-nav__icon md-icon"></span>
          2019
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2019/2019-02-20-how-to-use-slide-rules/" class="md-nav__link">
        How to use slide rules
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2019/2019-07-20-all-about-dieting/" class="md-nav__link">
        Food smarts
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="0">
          2020
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_4">
          <span class="md-nav__icon md-icon"></span>
          2020
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2020/2020-01-10-colossal_failure/" class="md-nav__link">
        A Colossal Failure
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2020/2020-02-09-the-hard-things/" class="md-nav__link">
        The Hard Thing About Hard Things
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2020/2020-02-11-who-gets-what/" class="md-nav__link">
        Who Gets What And Why
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2020/2020-03-01-many-ideas/" class="md-nav__link">
        Ideas From Many Fields
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2020/2020-04-25-motivation/" class="md-nav__link">
        What's my Motivation?
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../2020/2020-11-28-potpourri/" class="md-nav__link">
        Potpourri of items
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_5" checked>
      
      
      
        <label class="md-nav__link" for="__nav_4_5" id="__nav_4_5_label" tabindex="0">
          2022
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_5_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_4_5">
          <span class="md-nav__icon md-icon"></span>
          2022
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2022-12-31-colors/" class="md-nav__link">
        Design colors
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../predictions/" class="md-nav__link">
        Predictions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../think/" class="md-nav__link">
        Think
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_5_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4_5_4" id="__nav_4_5_4_label" tabindex="0">
          Finance
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_5_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_5_4">
          <span class="md-nav__icon md-icon"></span>
          Finance
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Finance/Stats/" class="md-nav__link">
        Statistics
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Finance/Trading/" class="md-nav__link">
        Trading
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_5_5" checked>
      
      
      
        <label class="md-nav__link" for="__nav_4_5_5" id="__nav_4_5_5_label" tabindex="0">
          Linux
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_5_5_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_4_5_5">
          <span class="md-nav__icon md-icon"></span>
          Linux
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Kernel Bypass
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Kernel Bypass
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#openonload" class="md-nav__link">
    OpenOnload
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#onload" class="md-nav__link">
    onload
  </a>
  
    <nav class="md-nav" aria-label="onload">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#packet-buffers" class="md-nav__link">
    packet buffers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kernel-polls" class="md-nav__link">
    kernel polls
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interrupts" class="md-nav__link">
    interrupts
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#packet-drops" class="md-nav__link">
    packet drops
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lock-contentions" class="md-nav__link">
    lock contentions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#network-stack" class="md-nav__link">
    network stack
  </a>
  
    <nav class="md-nav" aria-label="network stack">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#typical-network-flow" class="md-nav__link">
    typical network flow
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rx-path" class="md-nav__link">
    rx path
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#overheads" class="md-nav__link">
    overheads
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reading" class="md-nav__link">
    reading
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Linux/" class="md-nav__link">
        Linux notes
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_5_6" >
      
      
      
        <label class="md-nav__link" for="__nav_4_5_6" id="__nav_4_5_6_label" tabindex="0">
          ModernCpp
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_5_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_5_6">
          <span class="md-nav__icon md-icon"></span>
          ModernCpp
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ModernCpp/CuriousUseOfTemplates/" class="md-nav__link">
        Curious Use of Templates
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ModernCpp/Guide/" class="md-nav__link">
        Street Fighting Guide to Modern C++
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ModernCpp/MakeTips/" class="md-nav__link">
        Make Tips
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_5_7" >
      
      
      
        <label class="md-nav__link" for="__nav_4_5_7" id="__nav_4_5_7_label" tabindex="0">
          Notes
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_5_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4_5_7">
          <span class="md-nav__icon md-icon"></span>
          Notes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Notes/most/" class="md-nav__link">
        The Most Important Thing
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          Cheats
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Cheats
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../cheats/git/" class="md-nav__link">
        Git
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../../cheats/nix/" class="md-nav__link">
        Nix
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#openonload" class="md-nav__link">
    OpenOnload
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#onload" class="md-nav__link">
    onload
  </a>
  
    <nav class="md-nav" aria-label="onload">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#packet-buffers" class="md-nav__link">
    packet buffers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kernel-polls" class="md-nav__link">
    kernel polls
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#interrupts" class="md-nav__link">
    interrupts
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#packet-drops" class="md-nav__link">
    packet drops
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lock-contentions" class="md-nav__link">
    lock contentions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#network-stack" class="md-nav__link">
    network stack
  </a>
  
    <nav class="md-nav" aria-label="network stack">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#typical-network-flow" class="md-nav__link">
    typical network flow
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rx-path" class="md-nav__link">
    rx path
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#overheads" class="md-nav__link">
    overheads
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reading" class="md-nav__link">
    reading
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="kernel-bypass">Kernel Bypass</h1>
<h2 id="openonload">OpenOnload</h2>
<p>OpenOnload is software used for kernel bypass to work with Solarflare network 
cards.  By redirecting network IO to run through its own stack in/out of its
network card, applications can avoid network traffic latency encountered when 
relying on the kernel to send or receive data.  With all things kernel related,
your application must wait its turn depending on the whim of the kernel 
scheduler.  Other latencies are caused by data copies and context switching
when apps switch from kernel to user mode.</p>
<h2 id="onload">onload</h2>
<p>onload is the application to run Solarflare's kernel bypass software.  We need
to optimize onload settings for each application.  Dued to the paucity of 
optmisation tips on the net, I've put together some battle-field notes for 
optimising onload. </p>
<p>Use onload_stackdump to peek into onload stats and see which area needs 
tweaking.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%;"><span></span><code>onload_stackdump lots
</code></pre></div>
<p>Here are some areas that need looking into for each onloaded application:</p>
<ol>
<li>packet buffers</li>
<li>kernel polls </li>
<li>interrupts</li>
<li>packet drops</li>
<li>lock contentions</li>
</ol>
<h3 id="packet-buffers">packet buffers</h3>
<p>Check for the following statistics reported by onload_stackdump:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%;"><span></span><code>pkt_scramble0
pkt_scramble1
pkt_scramble2
memory_pressure_enter
memory_pressure_drops
</code></pre></div>
<p>The onload documentation states for each stat:</p>
<p><strong>pkt_scramble0</strong> is the number of times onload scrambled to find free buffers for 
L0 cache.  This is an indication of severe memory pressure. pkt_scramble1 and 
pkt_scramble2 are similar counts for L1 and L2 caches. </p>
<p><strong>memory_pressure_enter</strong> is the number of times onload has entered 'memory 
pressure' state.  <strong>memory_pressure_drops</strong> is the number of packets dropped 
due to 'memory pressure'. </p>
<p>Onload documentation states "When Onload detects a stack is close to allocating
all available packet buffers, it will take action to try and avoid packet buffer
exhaustion.  Onload will automatically start dropping packets on receive and,
where possible, will reduce the receive descriptor ring fill level in an attempt
to alleviate the situation." </p>
<p>For memory related issues, the documentation suggests bumping up EF_MAX_PACKETS.
This setting controls the maximum number of packet buffers that can be used by
the Onload stack. By default, updating EF_MAX_PACKETS also updates parameters
EF_MAX_RX_PACKETS and EF_MAX_TX_PACKETS to 75% of EF_MAX_PACKETS.</p>
<p>While increasing EF_MAX_PACKETS should be beneficial to preventing memory 
pressure problems, the downside of increasing this value too high is a larger
memomry footprint and resulting latency. </p>
<h3 id="kernel-polls">kernel polls</h3>
<p>Onload_stackdump shows the number of times a socket event was polled from the 
kernel versus user space, with the latter being preferred.  Examples:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%;"><span></span><code>k_polls: 34441
u_polls: 1870340303
</code></pre></div>
<p><strong>k_polls</strong> is the number of times the socket event queue was polled from the 
kernel while <strong>u_polls</strong> is the number of times the socket event queue was 
polled from user space.  We'd much prefer applications to read socket events 
from user space- bypassing kernel scheduling and data copies and context 
switching. </p>
<p>If k_polls &gt; u_polls, then one parameter to try is EF_POLL_USEC.  This setting 
gets onload to continuously poll in user space for the set number of microseconds..</p>
<p>When an application reads from a socket and no data is available, the call
will enter the OS kernel and block.  When data becomes available, the network
adapter will interrupt the CPU, allowing the kernel to reschedule the application
to continue.  <em>Blocking and interrupts are relatively expensive operations.</em></p>
<p>Onload can be configured to spin on the processor in user mode for up to 
a specific number of microseconds waiting for data from the network.<br />
If the spin period expires the processor will revert to conventional blocking
behavior.  Non-blocking sockets will always return immeidately as these are 
unaffected by spinning.</p>
<p>If a cpu core can be dedicated to each thread that blocks waiting for network 
IO, then spinning is the best method to achieve the lowest possible latency.</p>
<p>The documentation suggests using EF_POLL_USEC to increase the timeout a user
polls sockets before blocking- which then would require an interrupt wakeup 
from the kernel.  While this suggestion may work for single-threaded applications, 
the downside of a higher poll timeout can also block other threads from polling.
No one solution works for all applications.  The proper setting depends on the 
number of threads polling sockets and the level of incoming or outgoing data.</p>
<h3 id="interrupts">interrupts</h3>
<p>Onload_stackdump shows counts for each event- such as the number of data 
receive/sent events and the number of times an interrupt was used to poll. 
Examples:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%;"><span></span><code>rx_evs: 2092752987
tx_evs: 25770
interrupt_polls: 6688961
interrupt_evs: 12014176
interrupt_wakes: 5336668
</code></pre></div>
<p><strong>rx_evs</strong> and <strong>tx_evs</strong> are the number of events received and transmitted, 
respectively.  <strong>interrupt_polls</strong> is the number of times the stack is polled
and invoked by interrupts.  <strong>interrupt_evs</strong> is the number of events processed
invoked by interrupts.  Lastly, <strong>interrupt_wakes</strong> is the number of times
the application is woken by interrupt.</p>
<p>A high number of events handled by interrupts relative to the total number of 
packet receive events could mean latency caused by relying on interrupts. </p>
<p>The documentation advises setting a higher <strong>EF_POLL_USEC</strong>.  This gets polls 
to continuously poll the socket before timing out and then relying on interrupts
to get data.  This reduces the number of interrupts- and context switches- 
for reading socket packets.  But a higher poll timeout comes with a cost of 
blocking other threads from polling.  Finding the optimial setting requires testing. </p>
<h3 id="packet-drops">packet drops</h3>
<p>Packet losses over the network harm performance.  The Linux tool ethtool 
identifies packet drops. </p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%;"><span></span><code>ethtool -S &lt;interface&gt; | grep drop
    rx_noskb_drops: 0
    port_rx_nodesc_drops: 504905630
    port_rx_dp_di_dropped_packets: 1016728
</code></pre></div>
<p><strong>rx_noskb_drops</strong> is the number of packets dropped when there are not enough
socket buffers.  <strong>port_rx_nodesc_drops</strong> is the number of packets dropped 
when there are no further descriptors in the rx ring buffer.<br />
<strong>port_rx_dp_di_dropped_packets</strong> is the number of packts dropped by filters. </p>
<p>Onloa's documentation says "If packet loss is observed at the network level 
due to a lack of receive buffering try increasing the size of the receive 
descriptor queue size via <strong>EF_RXQ_SIZE</strong>.  If packet drops are observed at the
socket level, it may also be worth experimenting with socket buffer sizes 
via <strong>EF_UDP_RCVBUF</strong>.  Setting <strong>EF_EVS_PER_POLL</strong> to a higher value may also 
improve efficiency".</p>
<p>A larger rx ring buffer with a larger EF_RXQ_SIZE can absorb larger packet bursts
without drops but at an increase in process memory working set size.</p>
<p>EF_EVS_PER_POLL sets the number of hardware network events to handle before 
performing other work.  This setting presents a trade-off- larger values 
increase batching- which usually improves efficiency- but may also increase
the working set size- which could harm efficiency. </p>
<h3 id="lock-contentions">lock contentions</h3>
<p>Onload's documentation states, "When threads share a stack,a thread holding 
the stack lock blocks another thread."  High coutns in the stats 
<strong>interrupt_lock_contends</strong>, <strong>periodic_lock_contends</strong>, and 
<strong>timeout_interrupt_lock_contends</strong> can identify these lock contentions. </p>
<p>The documentation suggests to use <strong>EF_STACK_PER_THREAD</strong> to create a stack 
per thread.  If a multi-threaded application is doing lots of socket operations,
stack lock contention will lead to send/receive performance jitter.  In such 
cases improved perofmrance can be had when each contending thread has its own
stack.  This can be managed with EF_STACK_PER_THREAD which creates a separate
Onload stack for the stocks created by each thread.</p>
<p>If using EF_STACK_PER_THREAD, it may also be possible to bump up EF_POLL_USEC
since each user-space poll now no longer blocks other threads.</p>
<h2 id="network-stack">network stack</h2>
<h3 id="typical-network-flow">typical network flow</h3>
<p>Data packets flow from the TX application to the RX listener application.</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%;"><span></span><code>TX                      RX
-------------           -------------
Application             Application
Transport (L4)          Transport (L4)
Network (L3)            Network (L3)
Data link (L2)          Data link (L2)
NIC driver              NIC driver
NIC hardware            NIC hardware
</code></pre></div>
<p>Contents of a data packet:</p>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%;"><span></span><code>Ethernet header
    dest MAC, src MAC, type of next structure
IP header
    length, IP type, header checksum, src IP, dest IP
TCP header
    src IP, dest IP, checksum
payload
checksum
</code></pre></div>
<h3 id="rx-path">rx path</h3>
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%;"><span></span><code>Applications            in user space
--------------------------------------
NIC driver              in kernel space
tx and rx ring buffer   --&gt; packet buffers
NIC
</code></pre></div>
<p>The NIC driver preallocates packet buffers and the tx and rx ring buffers.<br />
Also, tx and rx ring buffers are shared between NIC and NIC driver.</p>
<p>What happens when a NIC receives a data packet?  It matches the incoming packet's
MAC address to the NIC's MAC address.  Next it verifies the ethernet checksum.</p>
<p>Next the NIC copies the data packet to the rx ring buffer using direct memory
access (DMA).  DMA alleviates any work by the cpu.  The NIC then triggers
an interrupt to notify the NIC driver there is incoming data.</p>
<p>The cpu interrupts the process in execution.  It switches to kernel space to
1) lookup the Interrupt Descriptor Table (IDT), 2) execute the interrupt's
registered service routine (ISR).  Then the cpu acks the interrupt and switches
back to user space.</p>
<p>Later, the cpu enters the kernel space again- this time driven by the <strong>NIC
driver</strong>.  The NIC driver dynamically allocates an sk buffer (skb) and update
its data structure with packet metadata.  The NIC driver removes the ethernet
header and then passes skb to the network stack.</p>
<p>The NIC driver calls L3 layer handling- verifying the IP addresses, checksums,
combines fragmented packets and then calls the higher L4 protocol handler.</p>
<p>The L4 layer enqueues the skb to the socket read queue.  The skb points to the
address of the data in the packet buffer.  Then it signals the socket.</p>
<p>The application in the user space reads the socket- with a system call that 
switches the process mode to kernel space.  This dequeues the packet from 
the socket receive queue, copies the packet to the application buffer, 
releases the skb and then returns control back to user space and to the user 
app.</p>
<h3 id="overheads">overheads</h3>
<p>There are too many context switches- back and forth from user to kernel modes.</p>
<p>There is context switching during a system read call.  There is a packet copy
before/during the read process.  There is a dynamic allocation of skb by the
NIC driver.  There is an interrupt for every arriving packet.  What a horrible
design.</p>
<p>A kernel bypass network stack bypasses all these overheads.  In a KB setup, 
there is no context switching (all user space) and there is no packet copy
from the kernel to the user handover.</p>
<h3 id="reading">reading</h3>
<p>Reading data packets can be done in two ways- via interrupt or via polling. </p>
<p>With interrupts, the NIC notifies the cpu a data packet arrived.  Interrupt
is a hardware mechanism.  This interrupt handling is slower for high speed
traffic.</p>
<p>With polling, the cpu keeps checking on the NIC.  This is a software-level
mechanism.  The cpu usage is high but this handles high speed traffic.</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": [], "search": "../../../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.b4d07000.min.js"></script>
      
    
  </body>
</html>