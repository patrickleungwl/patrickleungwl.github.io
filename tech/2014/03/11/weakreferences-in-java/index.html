<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <title> - A journal of tech issues in financial applications</title>
    <meta name="description" content="" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" type="text/css" href="http://patrickleungwl.github.io//assets/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Anonymous+Pro" />
    <!-- Customisation  -->
    <link rel="stylesheet" type="text/css" href="http://patrickleungwl.github.io//assets/css/main.css" />

</head>
<body class="home-template">

    <header class="main-header post-head no-cover">
    <nav class="main-nav  clearfix">
        <a class="back-button icon-arrow-left" href="http://patrickleungwl.github.io//">Home</a>
        <a class="subscribe-button icon-feed" href="http://patrickleungwl.github.io//feed.xml">Subscribe</a>
    </nav>
</header>

<main class="content" role="main">

    <article class="post">

        <header class="post-header">
            <h1 class="post-title">WeakReferences in Java</h1>
            <section class="post-meta">
                <time class="post-date" datetime="2014-03-11">11 Mar 2014</time>
                
                    on tech
                
            </section>
        </header>

        <section class="post-content">
            <p>Java as a language has been in the public eye for close to two decades now.  And there shouldn’t
really be anything new to an old techie, should there?  Well, surprise to say- there are some 
features that I rarely use.  One of these features is the “WeakReference”.</p>

<p>What are WeakReferences used for? WeakReferences are used for keeping objects in memory for only 
as long as a variable references it. As soon as this strong reference disappears, this object held 
by the WeakReference is up for garbage collection. This makes WeakReferences quite handy for 
keeping high storage-cost objects in memory for only as long as you really need it.</p>

<p>Example, let’s make a dummy class that does nothing but make heavy memory allocations:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">drills</span><span class="o">;</span> 

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DumbWeight</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">_weights</span><span class="o">;</span>
  
  <span class="kd">public</span> <span class="n">DumbWeight</span><span class="o">(</span><span class="kt">int</span> <span class="n">weight</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">_weights</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;(</span><span class="n">weight</span><span class="o">);</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">weight</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="n">_weights</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Integer</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

</code></pre>
</div>

<p>And here is the test code. The test code creates a thousand “DumbWeight” objects- each allocating one
hundred thousand Integers. While the WeakReferences keep track of the DumbWeights, we remove any strong
references to them. This leaves the WeakReference as the only link to the DumbWeights. The Garbage
Collector eventually spots this- and wipes out the DumbWeights over time. The CheckReferences method
periodically scans the set of WeakReferences to see if the DumbWeights still exist.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">drills</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.ref.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyTest</span> <span class="o">{</span> 

  <span class="cm">/** checkWeakReferences
   *  
   *  Check how many weak references still exist and not collected
   */</span>
  <span class="kd">private</span> <span class="kt">void</span> <span class="n">checkWeakReferences</span><span class="o">(</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">WeakReference</span><span class="o">&gt;</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">numCollected</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">WeakReference</span><span class="o">&gt;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
    <span class="k">while</span> <span class="o">(</span><span class="n">i</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">WeakReference</span> <span class="n">w</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
      <span class="n">DumbWeight</span> <span class="n">d</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">d</span><span class="o">==</span><span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">++</span><span class="n">numCollected</span><span class="o">;</span>
      <span class="o">}</span> 
    <span class="o">}</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"checkWeakRefs: size=%d, numCollected=%dn"</span><span class="o">,</span>
      <span class="n">s</span><span class="o">.</span><span class="na">size</span><span class="o">(),</span> <span class="n">numCollected</span> <span class="o">);</span>
  <span class="o">}</span> 

  <span class="o">/**</span> <span class="n">testWeakReferences</span>
   <span class="o">*</span>  
   <span class="o">*</span>  <span class="n">If</span> <span class="n">the</span> <span class="n">GC</span> <span class="n">collects</span> <span class="n">weak</span> <span class="n">references</span><span class="o">,</span> <span class="n">then</span> <span class="n">we</span> <span class="n">should</span> <span class="n">be</span>
   <span class="o">*</span>  <span class="n">able</span> <span class="n">to</span> <span class="n">create</span> <span class="n">objects</span> <span class="n">using</span> <span class="n">WR</span> <span class="n">indefinitely</span><span class="o">.</span>
   <span class="o">*</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="n">testWeakReferences</span><span class="o">()</span> <span class="o">{</span>

    <span class="n">Set</span><span class="o">&lt;</span><span class="n">WeakReference</span><span class="o">&gt;</span> <span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">WeakReference</span><span class="o">&gt;();</span>

    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"*****************************"</span><span class="o">);</span> 
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Starting testWeakReferences"</span><span class="o">);</span> 
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Creating 1000 weak references"</span><span class="o">);</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span><span class="mi">1000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="n">DumbWeight</span> <span class="n">d</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DumbWeight</span><span class="o">(</span><span class="mi">100000</span><span class="o">);</span>
      <span class="n">WeakReference</span> <span class="n">w</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WeakReference</span><span class="o">(</span><span class="n">d</span><span class="o">);</span>
      <span class="n">s</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">w</span><span class="o">);</span>
      <span class="n">d</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">size</span><span class="o">()%</span><span class="mi">100</span><span class="o">==</span><span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">checkWeakReferences</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
      <span class="o">}</span> 
    <span class="o">}</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Completed testWeakReferences"</span><span class="o">);</span> 
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="n">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span> 
    <span class="n">MyTest</span> <span class="n">m</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MyTest</span><span class="o">();</span>
    <span class="n">m</span><span class="o">.</span><span class="na">testWeakReferences</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>

</code></pre>
</div>
<p>The output of one such test run is shown below. The memory usage of this Test app stays in the 220 meg range on a Linux laptop with 2Gb RAM.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>*****************************
Starting testWeakReferences
Creating 1000 weak references
checkWeakRefs: size=100, numCollected=98
checkWeakRefs: size=200, numCollected=182
checkWeakRefs: size=300, numCollected=235
checkWeakRefs: size=400, numCollected=318
checkWeakRefs: size=500, numCollected=489
checkWeakRefs: size=600, numCollected=576
checkWeakRefs: size=700, numCollected=663
checkWeakRefs: size=800, numCollected=750
checkWeakRefs: size=900, numCollected=837
checkWeakRefs: size=1000, numCollected=924
Completed testWeakReferences

</code></pre>
</div>

<p>As shown, because the objects, the DumbWeight instances, are only “weakly referenced” and not strongly referenced, the GC always collects them whenever it runs.</p>

<p>Hope the test code makes clear this feature of WeakReference.</p>


        </section>

        <p>

        
            <section class="archive">
                <h5>Archive</h5>
                <ul>
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                            

                    
                </ul>
            </section>
        

        <footer class="post-footer">
            <!-- If we want to display author's name and bio -->
            

            <!-- Share links section -->
            <section class="share">
    <h4>Share this post</h4>
    <a class="icon-twitter" href="http://twitter.com/share?text=WeakReferences in Java&amp;url=/tech/2014/03/11/weakreferences-in-java/"
        onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=/tech/2014/03/11/weakreferences-in-java/"
        onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <span class="hidden">Facebook</span>
    </a>
    <a class="icon-google-plus" href="https://plus.google.com/share?url=/tech/2014/03/11/weakreferences-in-java/"
       onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
    </a>
</section>

            <!-- Disqus comments -->
            

        </footer>

    </article>

</main>



    <footer class="site-footer clearfix">
        

      <section class="copyright">
        <a href=""></a> &copy; 
               &bull; All rights reserved.
      </section>
      <section class="poweredby">Made with Jekyll using 
        <a href="http://github.com/rosario/kasper">Kasper theme</a>
      </section>
    </footer>
    
    <script type="text/javascript" src="http://patrickleungwl.github.io//assets/js/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="http://patrickleungwl.github.io//assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="http://patrickleungwl.github.io//assets/js/index.js"></script>

    <!-- Google Analytics Tracking code -->
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', '']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>   
</body>
</html>
