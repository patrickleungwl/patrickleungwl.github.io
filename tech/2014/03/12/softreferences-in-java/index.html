<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <title> - A journal of tech issues in financial applications</title>
    <meta name="description" content="" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" type="text/css" href="http://patrickleungwl.github.io//assets/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Anonymous+Pro" />
    <!-- Customisation  -->
    <link rel="stylesheet" type="text/css" href="http://patrickleungwl.github.io//assets/css/main.css" />

</head>
<body class="home-template">

    <header class="main-header post-head no-cover">
    <nav class="main-nav  clearfix">
        <a class="back-button icon-arrow-left" href="http://patrickleungwl.github.io//">Home</a>
        <a class="subscribe-button icon-feed" href="http://patrickleungwl.github.io//feed.xml">Subscribe</a>
    </nav>
</header>

<main class="content" role="main">

    <article class="post">

        <header class="post-header">
            <h1 class="post-title">SoftReferences in Java</h1>
            <section class="post-meta">
                <time class="post-date" datetime="2014-03-12">12 Mar 2014</time>
                
                    on tech
                
            </section>
        </header>

        <section class="post-content">
            <p>Continuing on with our investigation into memory handling in Java, let’s look at another 
rarely used feature- the SoftReference.  To get to the point, a SoftReference is 
just like a WeakReference- except that the Garbage Collector only collects its 
referenced object if the JVM is running low on memory.  This makes a SoftReference 
more “sticky” in a running process’s memory.</p>

<p>Here is a simple example of how a SoftReference works. Let’s reuse the same 
resource-heavy DumbWeight class shown in the previous WeakReference example. 
The following SoftReference test code example creates a thousand SoftReferences of 
DumbWeights, removes any strong references to the DumbWeights, and then 
periodically checks when and how often the GC cleans up the DumbWeight instances.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kn">package</span> <span class="n">drills</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.ref.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyTest</span> <span class="o">{</span> 

  <span class="cm">/** checkSoftReferences
   *  
   *  Check how many soft references still exist and not collected
   */</span>
  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">checkSoftReferences</span><span class="o">(</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">SoftReference</span><span class="o">&gt;</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">numCollected</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">SoftReference</span><span class="o">&gt;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
    <span class="k">while</span> <span class="o">(</span><span class="n">i</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">SoftReference</span> <span class="n">w</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
      <span class="n">DumbWeight</span> <span class="n">d</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">d</span><span class="o">==</span><span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">++</span><span class="n">numCollected</span><span class="o">;</span>
      <span class="o">}</span> 
    <span class="o">}</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"checkSoftRefs: size=%d, numCollected=%d\n"</span><span class="o">,</span> 
      <span class="n">s</span><span class="o">.</span><span class="na">size</span><span class="o">(),</span> <span class="n">numCollected</span> <span class="o">);</span>
  <span class="o">}</span>

  <span class="cm">/** testSoftReferences
   *  
   * Soft references are like weak references- 
   * except that soft references only get garbage collected
   * if the process is running out of heap memory.
   * 
   * This means soft references are more sticky than weak references.
   */</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSoftReferences</span><span class="o">()</span> <span class="o">{</span>

    <span class="n">Set</span><span class="o">&lt;</span><span class="n">SoftReference</span><span class="o">&gt;</span> <span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">SoftReference</span><span class="o">&gt;();</span>

    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"*****************************"</span><span class="o">);</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Starting testSoftReferences"</span><span class="o">);</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Creating 1000 soft references"</span><span class="o">);</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">1000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="n">DumbWeight</span> <span class="n">d</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DumbWeight</span><span class="o">(</span><span class="mi">100000</span><span class="o">);</span>
      <span class="n">SoftReference</span> <span class="n">w</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SoftReference</span><span class="o">(</span><span class="n">d</span><span class="o">);</span>
      <span class="n">s</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">w</span><span class="o">);</span>
      <span class="n">d</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">size</span><span class="o">()%</span><span class="mi">100</span><span class="o">==</span><span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">checkSoftReferences</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span> 
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Completed testSoftReferences"</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span> 
    <span class="n">MyTest</span> <span class="n">m</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MyTest</span><span class="o">();</span>
    <span class="n">m</span><span class="o">.</span><span class="na">testSoftReferences</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>The output looks as follows:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>*****************************
Starting testSoftReferences
Creating 1000 soft references
checkSoftRefs: size=100, numCollected=0
checkSoftRefs: size=200, numCollected=0
checkSoftRefs: size=300, numCollected=208
checkSoftRefs: size=400, numCollected=208
checkSoftRefs: size=500, numCollected=416
checkSoftRefs: size=600, numCollected=416
checkSoftRefs: size=700, numCollected=624
checkSoftRefs: size=800, numCollected=624
checkSoftRefs: size=900, numCollected=832
checkSoftRefs: size=1000, numCollected=832
Completed testSoftReferences
</code></pre>
</div>

<p>The test results show that the GC wipes out objects referenced by SoftReferences - 
only if the JVM runs low on memory. Comparing this result to the previous WeakReferences 
example, you can see that there is some lag time before the GC cleans up the 
SoftReferenced objects.</p>

<p>On a Mint Linux laptop with 2Gb ram, I noticed this test app consume at most 525Mb 
before GC occurs- and the process memory goes back down to around 300Mb.</p>

<p>These tests prove that both weak and soft references provide useful alternatives 
handling memory. For resource hungry or long running processes, both are viable 
solutions to tackling tough memory problems.</p>


        </section>

        <p>

        
            <section class="archive">
                <h5>Archive</h5>
                <ul>
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                    
                        
                            
                            

                    
                        <li><span>11 Mar 2014</span>
                          <a href="http://patrickleungwl.github.io//tech/2014/03/11/weakreferences-in-java/">WeakReferences in Java</a>
                        </li>
                    
                </ul>
            </section>
        

        <footer class="post-footer">
            <!-- If we want to display author's name and bio -->
            

            <!-- Share links section -->
            <section class="share">
    <h4>Share this post</h4>
    <a class="icon-twitter" href="http://twitter.com/share?text=SoftReferences in Java&amp;url=/tech/2014/03/12/softreferences-in-java/"
        onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=/tech/2014/03/12/softreferences-in-java/"
        onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <span class="hidden">Facebook</span>
    </a>
    <a class="icon-google-plus" href="https://plus.google.com/share?url=/tech/2014/03/12/softreferences-in-java/"
       onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
    </a>
</section>

            <!-- Disqus comments -->
            

        </footer>

    </article>

</main>



    <footer class="site-footer clearfix">
        

      <section class="copyright">
        <a href=""></a> &copy; 
               &bull; All rights reserved.
      </section>
      <section class="poweredby">Made with Jekyll using 
        <a href="http://github.com/rosario/kasper">Kasper theme</a>
      </section>
    </footer>
    
    <script type="text/javascript" src="http://patrickleungwl.github.io//assets/js/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="http://patrickleungwl.github.io//assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="http://patrickleungwl.github.io//assets/js/index.js"></script>

    <!-- Google Analytics Tracking code -->
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', '']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>   
</body>
</html>
